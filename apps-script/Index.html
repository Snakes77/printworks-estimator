<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PrintWorks Estimator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #1a1a1a;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }
    
    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #0066cc;
    }
    
    .operations-section {
      margin: 30px 0;
    }
    
    .operations-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .operation-tag {
      background: #e3f2fd;
      padding: 8px 12px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .operation-tag button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 20px;
      height: 20px;
    }
    
    .totals-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 4px;
      margin: 30px 0;
    }
    
    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .totals-row:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 18px;
      margin-top: 10px;
      padding-top: 15px;
      border-top: 2px solid #333;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-primary {
      background: #0066cc;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0052a3;
    }
    
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    th {
      background: #f9f9f9;
      font-weight: 600;
      color: #666;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .text-right {
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PrintWorks Estimator</h1>
    
    <div id="message"></div>
    
    <form id="quoteForm">
      <div class="form-grid">
        <div class="form-group">
          <label for="clientName">Client Name</label>
          <input type="text" id="clientName" name="clientName" required>
        </div>
        
        <div class="form-group">
          <label for="projectName">Project Name</label>
          <input type="text" id="projectName" name="projectName" required>
        </div>
        
        <div class="form-group">
          <label for="reference">Reference</label>
          <input type="text" id="reference" name="reference" required>
        </div>
        
        <div class="form-group">
          <label for="quantity">Quantity</label>
          <input type="number" id="quantity" name="quantity" min="1" value="20000" required>
        </div>
        
        <div class="form-group">
          <label for="envelopeType">Envelope Type</label>
          <select id="envelopeType" name="envelopeType" required>
            <option value="C5">C5</option>
            <option value="C4">C4</option>
            <option value="DL">DL</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="insertsCount">Inserts</label>
          <input type="number" id="insertsCount" name="insertsCount" min="0" value="1" required>
        </div>
        
        <div class="form-group">
          <label for="vatRate">VAT Rate</label>
          <select id="vatRate" name="vatRate" required>
            <option value="20">Standard VAT (20%)</option>
            <option value="0">Zero rated (0%)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="rateCardSelect">Add Operation</label>
          <select id="rateCardSelect">
            <option value="">Select operation...</option>
          </select>
        </div>
      </div>
      
      <div class="operations-section">
        <label>Selected Operations</label>
        <div id="operationsList" class="operations-list">
          <p style="color: #999;">No operations selected</p>
        </div>
      </div>
      
      <div class="totals-section">
        <h3 style="margin-bottom: 15px;">Quote Totals</h3>
        <div class="totals-row">
          <span>Subtotal (ex VAT)</span>
          <span id="subtotal">£0.00</span>
        </div>
        <div class="totals-row">
          <span>VAT (<span id="vatRateDisplay">20</span>%)</span>
          <span id="vat">£0.00</span>
        </div>
        <div class="totals-row">
          <span>Total (inc VAT)</span>
          <span id="total">£0.00</span>
        </div>
      </div>
      
      <div id="linesTable"></div>
      
      <div class="button-group">
        <button type="submit" class="btn-primary">Save and Finalise</button>
        <button type="button" class="btn-secondary" onclick="saveDraft()">Save Draft</button>
      </div>
    </form>
  </div>
  
  <script>
    let rateCards = [];
    let selectedRateCards = [];
    let previewData = null;
    
    // Load rate cards on page load
    google.script.run
      .withSuccessHandler(handleRateCards)
      .withFailureHandler(showError)
      .getRateCards();
    
    function handleRateCards(cards) {
      rateCards = cards;
      const select = document.getElementById('rateCardSelect');
      
      cards.forEach(card => {
        const option = document.createElement('option');
        option.value = card.code;
        option.textContent = card.name;
        select.appendChild(option);
      });
      
      select.addEventListener('change', function() {
        if (this.value && !selectedRateCards.includes(this.value)) {
          addRateCard(this.value);
          this.value = '';
        }
      });
    }
    
    function addRateCard(code) {
      if (!selectedRateCards.includes(code)) {
        selectedRateCards.push(code);
        updateOperationsList();
        calculatePreview();
      }
    }
    
    function removeRateCard(code) {
      selectedRateCards = selectedRateCards.filter(c => c !== code);
      updateOperationsList();
      calculatePreview();
    }
    
    function updateOperationsList() {
      const container = document.getElementById('operationsList');
      
      if (selectedRateCards.length === 0) {
        container.innerHTML = '<p style="color: #999;">No operations selected</p>';
        return;
      }
      
      container.innerHTML = selectedRateCards.map(code => {
        const card = rateCards.find(c => c.code === code);
        return `
          <div class="operation-tag">
            <span>${card.name}</span>
            <button onclick="removeRateCard('${code}')" title="Remove">×</button>
          </div>
        `;
      }).join('');
    }
    
    function calculatePreview() {
      if (selectedRateCards.length === 0) {
        updateTotals({ subtotal: 0, vat: 0, total: 0 });
        document.getElementById('linesTable').innerHTML = '';
        return;
      }
      
      const quantity = parseInt(document.getElementById('quantity').value);
      const insertsCount = parseInt(document.getElementById('insertsCount').value);
      const vatRate = parseInt(document.getElementById('vatRate').value);
      
      google.script.run
        .withSuccessHandler(handlePreview)
        .withFailureHandler(showError)
        .previewQuoteCalculation(quantity, insertsCount, vatRate, selectedRateCards);
    }
    
    function handlePreview(data) {
      if (data.error) {
        showError(data.error);
        return;
      }
      
      previewData = data;
      updateTotals(data.totals);
      updateLinesTable(data.lines);
    }
    
    function updateTotals(totals) {
      document.getElementById('subtotal').textContent = '£' + totals.subtotal;
      document.getElementById('vat').textContent = '£' + totals.vat;
      document.getElementById('total').textContent = '£' + totals.total;
      document.getElementById('vatRateDisplay').textContent = document.getElementById('vatRate').value;
    }
    
    function updateLinesTable(lines) {
      if (lines.length === 0) {
        document.getElementById('linesTable').innerHTML = '';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>Operation</th>
              <th class="text-right">Units (k)</th>
              <th class="text-right">Unit £/1k</th>
              <th class="text-right">Make-ready</th>
              <th class="text-right">Line Total</th>
            </tr>
          </thead>
          <tbody>
            ${lines.map(line => `
              <tr>
                <td>${line.description}</td>
                <td class="text-right">${line.units}</td>
                <td class="text-right">£${line.unitPrice}</td>
                <td class="text-right">£${line.makeReady}</td>
                <td class="text-right"><strong>£${line.lineTotal}</strong></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      document.getElementById('linesTable').innerHTML = html;
    }
    
    function showError(error) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = 'error';
      messageDiv.textContent = 'Error: ' + (error.message || error);
    }
    
    function showSuccess(message) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = 'success';
      messageDiv.textContent = message;
    }
    
    // Watch for changes to recalculate
    ['quantity', 'insertsCount', 'vatRate'].forEach(id => {
      document.getElementById(id).addEventListener('input', calculatePreview);
      document.getElementById(id).addEventListener('change', calculatePreview);
    });
    
    // Handle form submission
    document.getElementById('quoteForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (selectedRateCards.length === 0) {
        showError('Please add at least one operation');
        return;
      }
      
      const formData = {
        clientName: document.getElementById('clientName').value,
        projectName: document.getElementById('projectName').value,
        reference: document.getElementById('reference').value,
        quantity: parseInt(document.getElementById('quantity').value),
        envelopeType: document.getElementById('envelopeType').value,
        insertsCount: parseInt(document.getElementById('insertsCount').value),
        vatRate: parseInt(document.getElementById('vatRate').value),
        rateCardCodes: selectedRateCards
      };
      
      document.body.classList.add('loading');
      
      google.script.run
        .withSuccessHandler(handleQuoteCreated)
        .withFailureHandler(handleError)
        .createQuoteFromWeb(formData);
    });
    
    function handleQuoteCreated(result) {
      document.body.classList.remove('loading');
      
      if (result.error) {
        showError(result.error);
        return;
      }
      
      showSuccess('Quote created successfully! Quote ID: ' + result.quoteId);
      
      // Reset form
      document.getElementById('quoteForm').reset();
      selectedRateCards = [];
      updateOperationsList();
      calculatePreview();
    }
    
    function handleError(error) {
      document.body.classList.remove('loading');
      showError(error);
    }
    
    function saveDraft() {
      alert('Draft save functionality coming soon!');
    }
  </script>
</body>
</html>

